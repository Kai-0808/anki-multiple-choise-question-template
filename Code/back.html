<div id="myCard">
  <div class="back">
    {{#Main_text}}<div class="card-header">
      <div class="card-title">{{Main_text}}</div>
      {{#Note_ID}}<div class="note-id">{{Note_ID}}</div>{{/Note_ID}}
    </div>{{/Main_text}}

    {{^Main_text}}{{#Note_ID}}<div class="card-header">
      <div class="card-title"></div>
      <div class="note-id">{{Note_ID}}</div>
    </div>{{/Note_ID}}{{/Main_text}}

    <!-- Question 1 -->
    {{#Question_1}}<div class="question-block" data-question="1">
      <div class="question-header">
        <span class="question-number">1</span>{{Question_1}}
      </div>
      <form class="shuffle" data-question="1">
        {{#option_1_1 (A)}}<div class="container" id="1_A" data-question="1" data-option="A">
          <div class="circle"></div>
          <div class="option">{{option_1_1 (A)}}</div>
        </div>{{/option_1_1 (A)}}
        {{#option_1_2 (B)}}<div class="container" id="1_B" data-question="1" data-option="B">
          <div class="circle"></div>
          <div class="option">{{option_1_2 (B)}}</div>
        </div>{{/option_1_2 (B)}}
        {{#option_1_3 (C)}}<div class="container" id="1_C" data-question="1" data-option="C">
          <div class="circle"></div>
          <div class="option">{{option_1_3 (C)}}</div>
        </div>{{/option_1_3 (C)}}
        {{#option_1_4 (D)}}<div class="container" id="1_D" data-question="1" data-option="D">
          <div class="circle"></div>
          <div class="option">{{option_1_4 (D)}}</div>
        </div>{{/option_1_4 (D)}}
        {{#option_1_5 (E)}}<div class="container" id="1_E" data-question="1" data-option="E">
          <div class="circle"></div>
          <div class="option">{{option_1_5 (E)}}</div>
        </div>{{/option_1_5 (E)}}
        {{#option_1_6 (F)}}<div class="container" id="1_F" data-question="1" data-option="F">
          <div class="circle"></div>
          <div class="option">{{option_1_6 (F)}}</div>
        </div>{{/option_1_6 (F)}}
        {{#option_1_7 (G)}}<div class="container" id="1_G" data-question="1" data-option="G">
          <div class="circle"></div>
          <div class="option">{{option_1_7 (G)}}</div>
        </div>{{/option_1_7 (G)}}
        {{#option_1_8 (H)}}<div class="container" id="1_H" data-question="1" data-option="H">
          <div class="circle"></div>
          <div class="option">{{option_1_8 (H)}}</div>
        </div>{{/option_1_8 (H)}}
      </form>
    </div>{{/Question_1}}

    <!-- Question 2 -->
    {{#Question_2}}<div class="question-block" data-question="2">
      <div class="question-header">
        <span class="question-number">2</span>{{Question_2}}
      </div>
      <form class="shuffle" data-question="2">
        {{#option_2_1 (A)}}<div class="container" id="2_A" data-question="2" data-option="A">
          <div class="circle"></div>
          <div class="option">{{option_2_1 (A)}}</div>
        </div>{{/option_2_1 (A)}}
        {{#option_2_2 (B)}}<div class="container" id="2_B" data-question="2" data-option="B">
          <div class="circle"></div>
          <div class="option">{{option_2_2 (B)}}</div>
        </div>{{/option_2_2 (B)}}
        {{#option_2_3 (C)}}<div class="container" id="2_C" data-question="2" data-option="C">
          <div class="circle"></div>
          <div class="option">{{option_2_3 (C)}}</div>
        </div>{{/option_2_3 (C)}}
        {{#option_2_4 (D)}}<div class="container" id="2_D" data-question="2" data-option="D">
          <div class="circle"></div>
          <div class="option">{{option_2_4 (D)}}</div>
        </div>{{/option_2_4 (D)}}
        {{#option_2_5 (E)}}<div class="container" id="2_E" data-question="2" data-option="E">
          <div class="circle"></div>
          <div class="option">{{option_2_5 (E)}}</div>
        </div>{{/option_2_5 (E)}}
        {{#option_2_6 (F)}}<div class="container" id="2_F" data-question="2" data-option="F">
          <div class="circle"></div>
          <div class="option">{{option_2_6 (F)}}</div>
        </div>{{/option_2_6 (F)}}
        {{#option_2_7 (G)}}<div class="container" id="2_G" data-question="2" data-option="G">
          <div class="circle"></div>
          <div class="option">{{option_2_7 (G)}}</div>
        </div>{{/option_2_7 (G)}}
        {{#option_2_8 (H)}}<div class="container" id="2_H" data-question="2" data-option="H">
          <div class="circle"></div>
          <div class="option">{{option_2_8 (H)}}</div>
        </div>{{/option_2_8 (H)}}
      </form>
    </div>{{/Question_2}}

    <!-- Question 3 -->
    {{#Question_3}}<div class="question-block" data-question="3">
      <div class="question-header">
        <span class="question-number">3</span>{{Question_3}}
      </div>
      <form class="shuffle" data-question="3">
        {{#option_3_1 (A)}}<div class="container" id="3_A" data-question="3" data-option="A">
          <div class="circle"></div>
          <div class="option">{{option_3_1 (A)}}</div>
        </div>{{/option_3_1 (A)}}
        {{#option_3_2 (B)}}<div class="container" id="3_B" data-question="3" data-option="B">
          <div class="circle"></div>
          <div class="option">{{option_3_2 (B)}}</div>
        </div>{{/option_3_2 (B)}}
        {{#option_3_3 (C)}}<div class="container" id="3_C" data-question="3" data-option="C">
          <div class="circle"></div>
          <div class="option">{{option_3_3 (C)}}</div>
        </div>{{/option_3_3 (C)}}
        {{#option_3_4 (D)}}<div class="container" id="3_D" data-question="3" data-option="D">
          <div class="circle"></div>
          <div class="option">{{option_3_4 (D)}}</div>
        </div>{{/option_3_4 (D)}}
        {{#option_3_5 (E)}}<div class="container" id="3_E" data-question="3" data-option="E">
          <div class="circle"></div>
          <div class="option">{{option_3_5 (E)}}</div>
        </div>{{/option_3_5 (E)}}
        {{#option_3_6 (F)}}<div class="container" id="3_F" data-question="3" data-option="F">
          <div class="circle"></div>
          <div class="option">{{option_3_6 (F)}}</div>
        </div>{{/option_3_6 (F)}}
        {{#option_3_7 (G)}}<div class="container" id="3_G" data-question="3" data-option="G">
          <div class="circle"></div>
          <div class="option">{{option_3_7 (G)}}</div>
        </div>{{/option_3_7 (G)}}
        {{#option_3_8 (H)}}<div class="container" id="3_H" data-question="3" data-option="H">
          <div class="circle"></div>
          <div class="option">{{option_3_8 (H)}}</div>
        </div>{{/option_3_8 (H)}}
      </form>
    </div>{{/Question_3}}

    <!-- Question 4 -->
    {{#Question_4}}<div class="question-block" data-question="4">
      <div class="question-header">
        <span class="question-number">4</span>{{Question_4}}
      </div>
      <form class="shuffle" data-question="4">
        {{#option_4_1 (A)}}<div class="container" id="4_A" data-question="4" data-option="A">
          <div class="circle"></div>
          <div class="option">{{option_4_1 (A)}}</div>
        </div>{{/option_4_1 (A)}}
        {{#option_4_2 (B)}}<div class="container" id="4_B" data-question="4" data-option="B">
          <div class="circle"></div>
          <div class="option">{{option_4_2 (B)}}</div>
        </div>{{/option_4_2 (B)}}
        {{#option_4_3 (C)}}<div class="container" id="4_C" data-question="4" data-option="C">
          <div class="circle"></div>
          <div class="option">{{option_4_3 (C)}}</div>
        </div>{{/option_4_3 (C)}}
        {{#option_4_4 (D)}}<div class="container" id="4_D" data-question="4" data-option="D">
          <div class="circle"></div>
          <div class="option">{{option_4_4 (D)}}</div>
        </div>{{/option_4_4 (D)}}
        {{#option_4_5 (E)}}<div class="container" id="4_E" data-question="4" data-option="E">
          <div class="circle"></div>
          <div class="option">{{option_4_5 (E)}}</div>
        </div>{{/option_4_5 (E)}}
        {{#option_4_6 (F)}}<div class="container" id="4_F" data-question="4" data-option="F">
          <div class="circle"></div>
          <div class="option">{{option_4_6 (F)}}</div>
        </div>{{/option_4_6 (F)}}
        {{#option_4_7 (G)}}<div class="container" id="4_G" data-question="4" data-option="G">
          <div class="circle"></div>
          <div class="option">{{option_4_7 (G)}}</div>
        </div>{{/option_4_7 (G)}}
        {{#option_4_8 (H)}}<div class="container" id="4_H" data-question="4" data-option="H">
          <div class="circle"></div>
          <div class="option">{{option_4_8 (H)}}</div>
        </div>{{/option_4_8 (H)}}
      </form>
    </div>{{/Question_4}}

    <!-- Question 5 -->
    {{#Question_5}}<div class="question-block" data-question="5">
      <div class="question-header">
        <span class="question-number">5</span>{{Question_5}}
      </div>
      <form class="shuffle" data-question="5">
        {{#option_5_1 (A)}}<div class="container" id="5_A" data-question="5" data-option="A">
          <div class="circle"></div>
          <div class="option">{{option_5_1 (A)}}</div>
        </div>{{/option_5_1 (A)}}
        {{#option_5_2 (B)}}<div class="container" id="5_B" data-question="5" data-option="B">
          <div class="circle"></div>
          <div class="option">{{option_5_2 (B)}}</div>
        </div>{{/option_5_2 (B)}}
        {{#option_5_3 (C)}}<div class="container" id="5_C" data-question="5" data-option="C">
          <div class="circle"></div>
          <div class="option">{{option_5_3 (C)}}</div>
        </div>{{/option_5_3 (C)}}
        {{#option_5_4 (D)}}<div class="container" id="5_D" data-question="5" data-option="D">
          <div class="circle"></div>
          <div class="option">{{option_5_4 (D)}}</div>
        </div>{{/option_5_4 (D)}}
        {{#option_5_5 (E)}}<div class="container" id="5_E" data-question="5" data-option="E">
          <div class="circle"></div>
          <div class="option">{{option_5_5 (E)}}</div>
        </div>{{/option_5_5 (E)}}
        {{#option_5_6 (F)}}<div class="container" id="5_F" data-question="5" data-option="F">
          <div class="circle"></div>
          <div class="option">{{option_5_6 (F)}}</div>
        </div>{{/option_5_6 (F)}}
        {{#option_5_7 (G)}}<div class="container" id="5_G" data-question="5" data-option="G">
          <div class="circle"></div>
          <div class="option">{{option_5_7 (G)}}</div>
        </div>{{/option_5_7 (G)}}
        {{#option_5_8 (H)}}<div class="container" id="5_H" data-question="5" data-option="H">
          <div class="circle"></div>
          <div class="option">{{option_5_8 (H)}}</div>
        </div>{{/option_5_8 (H)}}
      </form>
    </div>{{/Question_5}}

    {{#Explanation}}<div id="extra-section">
      <div id="extra-header" class="header header-yellow" onclick="$('#extra').toggle(100)">
        Explanation
      </div>
      <div id="extra" class="content">
        <div>{{Explanation}}</div>
      </div>
    </div>{{/Explanation}}

  </div>
  <div id="settings">
    <div id="gear">
      <svg width="50px" height="50px" viewBox="0 0 48 48" version="1" xmlns="http://www.w3.org/2000/svg"
        enable-background="new 0 0 48 48">
        <path fill="#607D8B"
          d="M39.6,27.2c0.1-0.7,0.2-1.4,0.2-2.2s-0.1-1.5-0.2-2.2l4.5-3.2c0.4-0.3,0.6-0.9,0.3-1.4L40,10.8 c-0.3-0.5-0.8-0.7-1.3-0.4l-5,2.3c-1.2-0.9-2.4-1.6-3.8-2.2l-0.5-5.5c-0.1-0.5-0.5-0.9-1-0.9h-8.6c-0.5,0-1,0.4-1,0.9l-0.5,5.5 c-1.4,0.6-2.7,1.3-3.8,2.2l-5-2.3c-0.5-0.2-1.1,0-1.3,0.4l-4.3,7.4c-0.3,0.5-0.1,1.1,0.3,1.4l4.5,3.2c-0.1,0.7-0.2,1.4-0.2,2.2 s0.1,1.5,0.2,2.2L4,30.4c-0.4,0.3-0.6,0.9-0.3,1.4L8,39.2c0.3,0.5,0.8,0.7,1.3,0.4l5-2.3c1.2,0.9,2.4,1.6,3.8,2.2l0.5,5.5 c0.1,0.5,0.5,0.9,1,0.9h8.6c0.5,0,1-0.4,1-0.9l0.5-5.5c1.4-0.6,2.7-1.3,3.8-2.2l5,2.3c0.5,0.2,1.1,0,1.3-0.4l4.3-7.4 c0.3-0.5,0.1-1.1-0.3-1.4L39.6,27.2z M24,35c-5.5,0-10-4.5-10-10c0-5.5,4.5-10,10-10c5.5,0,10,4.5,10,10C34,30.5,29.5,35,24,35z" />
        <path fill="#455A64"
          d="M24,13c-6.6,0-12,5.4-12,12c0,6.6,5.4,12,12,12s12-5.4,12-12C36,18.4,30.6,13,24,13z M24,30 c-2.8,0-5-2.2-5-5c0-2.8,2.2-5,5-5s5,2.2,5,5C29,27.8,26.8,30,24,30z" />
      </svg>
    </div>
    <div id="settings-content" style="display:none">
      <div id="zoom">
        <div id="positive">
          <svg width="50px" height="50px" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
            <title>70 Basic icons by Xicons.co</title>
            <path d="M24,3A21,21,0,1,0,45,24,21,21,0,0,0,24,3Z" fill="#afe0f5" />
            <path d="M32,26H16a2,2,0,0,1,0-4H32A2,2,0,0,1,32,26Z" fill="#38b1e7" />
            <path d="M24,34a2,2,0,0,1-2-2V16a2,2,0,0,1,4,0V32A2,2,0,0,1,24,34Z" fill="#38b1e7" />
          </svg>
        </div>
        <div id="default">
          <svg width="50px" height="50px" version="1.1" viewBox="0 0 496.17 496.17" xml:space="preserve"
            xmlns="http://www.w3.org/2000/svg">
            <path
              d="m5e-3 248.09c0-137.02 111.07-248.09 248.07-248.09 137.01 0 248.08 111.06 248.08 248.09 0 137-111.07 248.08-248.08 248.08-137.01 0-248.07-111.08-248.07-248.08z"
              fill="#32BEA6" />
            <path
              d="m400.81 169.58c-2.502-4.865-14.695-16.012-35.262-5.891-20.564 10.122-10.625 32.351-10.625 32.351 7.666 15.722 11.98 33.371 11.98 52.046 0 65.622-53.201 118.82-118.83 118.82-65.619 0-118.82-53.202-118.82-118.82 0-61.422 46.6-111.95 106.36-118.17v30.793s-0.084 1.836 1.828 2.999c1.906 1.163 3.818 0 3.818 0l98.576-58.083s2.211-1.162 2.211-3.436c0-1.873-2.211-3.205-2.211-3.205l-98.248-57.754s-2.24-1.605-4.23-0.826c-1.988 0.773-1.744 3.481-1.744 3.481v32.993c-88.998 6.392-159.23 80.563-159.23 171.21 0 94.824 76.873 171.7 171.69 171.7 94.828 0 171.71-76.872 171.71-171.7 1e-3 -28.298-6.852-54.98-18.972-78.505z"
              fill="#F7F7F7" />
          </svg>
        </div>
        <div id="negative">
          <svg width="50px" height="50px" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
            <title>70 Basic icons by Xicons.co</title>
            <path d="M24,3A21,21,0,1,0,45,24,21,21,0,0,0,24,3Z" fill="#f8bcc4" />
            <path d="M32,26H16a2,2,0,0,1,0-4H32A2,2,0,0,1,32,26Z" fill="#ee586c" />
          </svg>
        </div>
      </div>
      <div id="switch">
        <div class="check-box">
          <label for="Shuffling">Shuffling</label>
          <input id="Shuffling" type="checkbox">
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  //-----------------------------------------------persistence
  if (void 0 === window.Persistence) { var e = "github.com/SimonLammer/anki-persistence/", t = "_default"; if (window.Persistence_sessionStorage = function () { var i = !1; try { "object" == typeof window.sessionStorage && (i = !0, this.clear = function () { for (var t = 0; t < sessionStorage.length; t++) { var i = sessionStorage.key(t); 0 == i.indexOf(e) && (sessionStorage.removeItem(i), t--) } }, this.setItem = function (i, n) { void 0 == n && (n = i, i = t), sessionStorage.setItem(e + i, JSON.stringify(n)) }, this.getItem = function (i) { return void 0 == i && (i = t), JSON.parse(sessionStorage.getItem(e + i)) }, this.removeItem = function (i) { void 0 == i && (i = t), sessionStorage.removeItem(e + i) }, this.getAllKeys = function () { for (var t = [], i = Object.keys(sessionStorage), n = 0; n < i.length; n++) { var s = i[n]; 0 == s.indexOf(e) && t.push(s.substring(e.length, s.length)) } return t.sort() }) } catch (n) { } this.isAvailable = function () { return i } }, window.Persistence_windowKey = function (i) { var n = window[i], s = !1; "object" == typeof n && (s = !0, this.clear = function () { n[e] = {} }, this.setItem = function (i, s) { void 0 == s && (s = i, i = t), n[e][i] = s }, this.getItem = function (i) { return void 0 == i && (i = t), void 0 == n[e][i] ? null : n[e][i] }, this.removeItem = function (i) { void 0 == i && (i = t), delete n[e][i] }, this.getAllKeys = function () { return Object.keys(n[e]) }, void 0 == n[e] && this.clear()), this.isAvailable = function () { return s } }, window.Persistence = new Persistence_sessionStorage, Persistence.isAvailable() || (window.Persistence = new Persistence_windowKey("py")), !Persistence.isAvailable()) { var i = window.location.toString().indexOf("title"), n = window.location.toString().indexOf("main", i); i > 0 && n > 0 && n - i < 10 && (window.Persistence = new Persistence_windowKey("qt")) } }

  //-------------------------------------------------------------remove empty fields
  var divs = document.querySelectorAll('.option');
  divs.forEach(div => {
    if (div.innerHTML === '') {
      div.parentNode.remove();
    }
  });

  //-----------------------------------------------variables
  document.getElementById("myCard").scrollTop = Persistence.getItem("scroll");

  // Get stored answers - support both new and old format for backward compatibility
  var storedAnswers = Persistence.getItem("answers") || {};
  var oldAnswer = Persistence.getItem("answer");

  var correctAnswers = {
    1: "{{Ans_1}}",
    2: "{{Ans_2}}",
    3: "{{Ans_3}}",
    4: "{{Ans_4}}",
    5: "{{Ans_5}}"
  };

  // Process correct answers to uppercase  
  Object.keys(correctAnswers).forEach(key => {
    if (correctAnswers[key] && correctAnswers[key] !== correctAnswers[key].toLowerCase()) {
      correctAnswers[key] = correctAnswers[key].toUpperCase();
    }
  });

  var allQuestions = [1, 2, 3, 4, 5];
  var activeQuestions = [];

  // Find active questions
  allQuestions.forEach(qNum => {
    var questionElement = document.querySelector(`[data-question="${qNum}"]`);
    if (questionElement) {
      activeQuestions.push(qNum);
    }
  });

  // For backward compatibility with single question format
  if (activeQuestions.length === 1 && activeQuestions[0] === 1 && oldAnswer && !storedAnswers[1]) {
    storedAnswers[1] = oldAnswer;
  }

  var TrueSVG = "<svg xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' version='1.1' width='25' height='25' viewBox='0 0 256 256' xml:space='preserve'><defs></defs><g style='stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;' transform='translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)' ><circle cx='45' cy='45' r='45' style='stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: rgb(5,152,98); fill-rule: nonzero; opacity: 1;' transform='  matrix(1 0 0 1 0 0) '/><path d='M 38.478 66 c -0.013 0 -0.026 0 -0.039 0 c -1.733 -0.012 -3.377 -0.771 -4.508 -2.085 L 20.453 48.263 c -2.162 -2.511 -1.879 -6.299 0.632 -8.462 c 2.51 -2.163 6.299 -1.879 8.462 0.632 l 8.991 10.441 l 21.967 -24.848 c 2.194 -2.485 5.988 -2.716 8.469 -0.521 c 2.483 2.195 2.717 5.986 0.521 8.469 l -26.522 30 C 41.834 65.263 40.197 66 38.478 66 z' style='stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: rgb(255,255,255); fill-rule: nonzero; opacity: 1;' transform=' matrix(1 0 0 1 0 0) ' stroke-linecap='round' /></g></svg>";
  var FalseSVG = "<svg xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' version='1.1' width='25' height='25' viewBox='0 0 256 256' xml:space='preserve'><defs></defs><g style='stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;' transform='translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)' ><path d='M 45 90 C 20.187 90 0 69.813 0 45 C 0 20.187 20.187 0 45 0 c 24.813 0 45 20.187 45 45 C 90 69.813 69.813 90 45 90 z' style='stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: rgb(255, 89, 90); fill-rule: nonzero; opacity: 1;' transform=' matrix(1 0 0 1 0 0) ' stroke-linecap='round' /><path d='M 28.902 66.098 c -1.28 0 -2.559 -0.488 -3.536 -1.465 c -1.953 -1.952 -1.953 -5.118 0 -7.07 l 32.196 -32.196 c 1.951 -1.952 5.119 -1.952 7.07 0 c 1.953 1.953 1.953 5.119 0 7.071 L 32.438 64.633 C 31.461 65.609 30.182 66.098 28.902 66.098 z' style='stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: rgb(255,255,255); fill-rule: nonzero; opacity: 1;' transform=' matrix(1 0 0 1 0 0) ' stroke-linecap='round' /><path d='M 61.098 66.098 c -1.279 0 -2.56 -0.488 -3.535 -1.465 L 25.367 32.438 c -1.953 -1.953 -1.953 -5.119 0 -7.071 c 1.953 -1.952 5.118 -1.952 7.071 0 l 32.195 32.196 c 1.953 1.952 1.953 5.118 0 7.07 C 63.657 65.609 62.377 66.098 61.098 66.098 z' style='stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: rgb(255,255,255); fill-rule: nonzero; opacity: 1;' transform=' matrix(1 0 0 1 0 0) ' stroke-linecap='round' /></g></svg>";
  var WarningSVG = "<svg xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' version='1.1' width='25' height='25' viewBox='0 0 256 256' xml:space='preserve'><defs></defs><g style='stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;' transform='translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)'><path d='M 45 90 C 20.187 90 0 69.813 0 45 C 0 20.187 20.187 0 45 0 c 24.813 0 45 20.187 45 45 C 90 69.813 69.813 90 45 90 z' style='stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: rgb(255,165,0); fill-rule: nonzero; opacity: 1;' transform='  matrix(1 0 0 1 0 0) ' stroke-linecap='round'/><path d='M 45 23 c -3.314 0 -6 2.686 -6 6 v 24 c 0 3.314 2.686 6 6 6 s 6 -2.686 6 -6 V 29 C 51 25.686 48.314 23 45 23 z' style='stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: rgb(255,255,255); fill-rule: nonzero; opacity: 1;' transform='  matrix(1 0 0 1 0 0) ' stroke-linecap='round'/><circle cx='45' cy='67' r='6' style='stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: rgb(255,255,255); fill-rule: nonzero; opacity: 1;' transform='  matrix(1 0 0 1 0 0) '/></g></svg>";

  //------------------------------------zoom
  if (Persistence.getItem("Zoom") == null) {
    Persistence.setItem("Zoom", 1);
  }
  var zoom = Persistence.getItem("Zoom");
  $('.back').css('zoom', zoom);
  $('#positive').on('click', function () {
    zoom += 0.1;
    Persistence.setItem("Zoom", zoom);
    $('.back').css('zoom', zoom);
  });
  $('#default').on('click', function () {
    zoom = 1;
    Persistence.setItem("Zoom", zoom);
    $('.back').css('zoom', zoom);
  });
  $('#negative').on('click', function () {
    zoom -= 0.1;
    Persistence.setItem("Zoom", zoom);
    $('.back').css('zoom', zoom);
  });
  $('#gear').on('click', function () {
    $('#settings-content').toggle(50);
    setTimeout(function () {
      $('#myCard').scrollTop($('#myCard')[0].scrollHeight);
    }, 100);
  });

  //-------------------------------------------------------------functions
  function shuffle(elems, questionNum) {
    var allElems = Array.from(elems);
    var shuffled = new Array(allElems.length);

    allElems.forEach((elem, originalIndex) => {
      var newPosition = Persistence.getItem("order_" + questionNum + "_" + originalIndex);

      if (newPosition !== null && newPosition < shuffled.length) {
        shuffled[newPosition] = elem;
      } else {
        // Find first empty slot
        var emptyIndex = shuffled.findIndex(slot => slot === undefined);
        if (emptyIndex !== -1) {
          shuffled[emptyIndex] = elem;
        }
      }
    });

    console.log(`Restored shuffle for question ${questionNum}`);

    // Replace elements in DOM - SAFER approach
    var parent = elems[0].parentNode;
    var nextSibling = elems[elems.length - 1].nextSibling;

    // Remove all existing elements first
    allElems.forEach(elem => {
      if (elem.parentNode) {
        elem.parentNode.removeChild(elem);
      }
    });

    // Insert shuffled elements in correct order
    shuffled.forEach((elem, index) => {
      if (elem) {
        if (nextSibling) {
          parent.insertBefore(elem, nextSibling);
        } else {
          parent.appendChild(elem);
        }
      }
    });
  }

  function reverseShuffle(elems, questionNum) {
    var elementsArray = Array.from(elems);
    var optionOrder = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];

    elementsArray.sort((a, b) => {
      var aOption = a.getAttribute('data-option');
      var bOption = b.getAttribute('data-option');
      return optionOrder.indexOf(aOption) - optionOrder.indexOf(bOption);
    });

    elementsArray.forEach((elem, index) => {
      if (elems[index] !== elem) {
        elems[index].parentNode.insertBefore(elem, elems[index].nextSibling);
        elems[index].parentNode.removeChild(elems[index]);
      }
    });
  }

  function addOptionLetters() {
    activeQuestions.forEach(qNum => {
      var containers = document.querySelectorAll(`[data-question="${qNum}"].container`);
      containers.forEach((container, index) => {
        var optionText = container.querySelector('.option');
        if (optionText) {
          // Remove existing letters first
          var existingLetters = optionText.querySelector('.Letters');
          if (existingLetters) {
            existingLetters.remove();
          }
          // Add letters in alphabetical order (A, B, C, D...)
          optionText.innerHTML = "<span class='Letters'>(" + String.fromCharCode(65 + index) + ")&nbsp;</span>" + optionText.innerHTML;
        }
      });
    });
  }

  //-------------------------------------------------------------------------------------------
  // Process each active question
  activeQuestions.forEach(qNum => {
    var userAnswer = storedAnswers[qNum] || "";
    var correctAnswer = correctAnswers[qNum] || "";

    console.log(`Q${qNum}: User='${userAnswer}', Correct='${correctAnswer}'`);

    // First, mark ALL user answers as wrong (with FalseSVG)
    if (userAnswer && userAnswer.length > 0) {
      for (var i = 0; i < userAnswer.length; i++) {
        var userLetter = userAnswer.split('')[i];
        if (userLetter !== " ") {
          var userElement = $("#" + qNum + "_" + userLetter);
          userElement.find(">.circle").append(FalseSVG);
        }
      }
    }

    // Then, mark correct answers based on whether user selected them
    if (correctAnswer && correctAnswer.length > 0) {
      if (isNaN(parseInt(correctAnswer))) {
        // Letter format (e.g., "A", "BC", etc.)
        for (var i = 0; i < correctAnswer.length; i++) {
          var correctLetter = correctAnswer.split('')[i];
          if (correctLetter !== " ") {
            var elementId = qNum + "_" + correctLetter;
            var wasSelectedByUser = userAnswer.includes(correctLetter);

            var correctElement = $("#" + elementId);
            correctElement.find(">.circle").empty();

            if (wasSelectedByUser) {
              // User selected this correct answer - green checkmark
              correctElement.find(">.circle").append(TrueSVG);
              correctElement.find(">.option").addClass("true");
            } else {
              // User missed this correct answer - warning symbol
              correctElement.find(">.circle").append(WarningSVG);
              correctElement.find(">.option").addClass("true");
            }
          }
        }
      } else {
        // Number format (e.g., "1", "23", etc.)
        for (var i = 0; i < correctAnswer.length; i++) {
          var correctNumber = correctAnswer.split('')[i];
          if (correctNumber !== " ") {
            var converted = String.fromCharCode(parseInt(correctNumber) + 64);
            var elementId = qNum + "_" + converted;
            var wasSelectedByUser = userAnswer.includes(converted);

            var correctElement = $("#" + elementId);
            correctElement.find(">.circle").empty();

            if (wasSelectedByUser) {
              // User selected this correct answer - green checkmark
              correctElement.find(">.circle").append(TrueSVG);
              correctElement.find(">.option").addClass("true");
            } else {
              // User missed this correct answer - warning symbol
              correctElement.find(">.circle").append(WarningSVG);
              correctElement.find(">.option").addClass("true");
            }
          }
        }
      }
    }
  });

  // Add option letters to each question initially 
  addOptionLetters();

  function HandleShufflingBox() {
    Persistence.setItem("ShufflingBox", $("#Shuffling").is(":checked"));

    activeQuestions.forEach(qNum => {
      var questionElems = document.querySelectorAll(`[data-question="${qNum}"].container`);
      if ($("#Shuffling").is(":checked")) {
        shuffle(questionElems, qNum);
        addOptionLetters(); // Re-add letters in correct order after shuffle
      } else {
        reverseShuffle(questionElems, qNum);
        addOptionLetters(); // Re-add letters in correct order after reverse shuffle
      }
    });
  }

  document.querySelector("#Shuffling").addEventListener("click", HandleShufflingBox);
  $("#Shuffling").prop("checked", Persistence.getItem("ShufflingBox"));

  if ($("#Shuffling").is(":checked")) {
    activeQuestions.forEach(qNum => {
      var questionElems = document.querySelectorAll(`[data-question="${qNum}"].container`);
      shuffle(questionElems, qNum);
      addOptionLetters(); // Re-add letters in correct order after shuffle
    });
  }
</script>