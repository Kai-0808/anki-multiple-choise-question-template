<div id="myCard">
  <div class="front">
    {{#Main_text}}<div class="card-header">
      <div class="card-title"><span class="jp">{{kanji:Main_text}}</span></div>
      {{#Note_ID}}<div class="note-id">{{Note_ID}}</div>{{/Note_ID}}
    </div>{{/Main_text}}

    {{^Main_text}}{{#Note_ID}}<div class="card-header">
      <div class="card-title"></div>
      <div class="note-id">{{Note_ID}}</div>
    </div>{{/Note_ID}}{{/Main_text}}

    <!-- Question 1 -->
    {{#Question_1}}<div class="question-block" data-question="1">
      <div class="question-header">
        <span class="question-number">1</span><span class="jp">{{kanji:Question_1}}</span>
      </div>
      <form class="shuffle" data-question="1">
        {{#option_1_1 (A)}}<div class="container" id="1_A" data-question="1" data-option="A">
          <input type="checkbox" name="radAnswer_1" class="checkbox" id="1_A">
          <div class="option"><span class="jp">{{kanji:option_1_1 (A)}}</span></div>
        </div>{{/option_1_1 (A)}}
        {{#option_1_2 (B)}}<div class="container" id="1_B" data-question="1" data-option="B">
          <input type="checkbox" name="radAnswer_1" class="checkbox" id="1_B">
          <div class="option"><span class="jp">{{kanji:option_1_2 (B)}}</span></div>
        </div>{{/option_1_2 (B)}}
        {{#option_1_3 (C)}}<div class="container" id="1_C" data-question="1" data-option="C">
          <input type="checkbox" name="radAnswer_1" class="checkbox" id="1_C">
          <div class="option"><span class="jp">{{kanji:option_1_3 (C)}}</span></div>
        </div>{{/option_1_3 (C)}}
        {{#option_1_4 (D)}}<div class="container" id="1_D" data-question="1" data-option="D">
          <input type="checkbox" name="radAnswer_1" class="checkbox" id="1_D">
          <div class="option"><span class="jp">{{kanji:option_1_4 (D)}}</span></div>
        </div>{{/option_1_4 (D)}}
        {{#option_1_5 (E)}}<div class="container" id="1_E" data-question="1" data-option="E">
          <input type="checkbox" name="radAnswer_1" class="checkbox" id="1_E">
          <div class="option"><span class="jp">{{kanji:option_1_5 (E)}}</span></div>
        </div>{{/option_1_5 (E)}}
        {{#option_1_6 (F)}}<div class="container" id="1_F" data-question="1" data-option="F">
          <input type="checkbox" name="radAnswer_1" class="checkbox" id="1_F">
          <div class="option"><span class="jp">{{kanji:option_1_6 (F)}}</span></div>
        </div>{{/option_1_6 (F)}}
        {{#option_1_7 (G)}}<div class="container" id="1_G" data-question="1" data-option="G">
          <input type="checkbox" name="radAnswer_1" class="checkbox" id="1_G">
          <div class="option"><span class="jp">{{kanji:option_1_7 (G)}}</span></div>
        </div>{{/option_1_7 (G)}}
        {{#option_1_8 (H)}}<div class="container" id="1_H" data-question="1" data-option="H">
          <input type="checkbox" name="radAnswer_1" class="checkbox" id="1_H">
          <div class="option"><span class="jp">{{kanji:option_1_8 (H)}}</span></div>
        </div>{{/option_1_8 (H)}}
      </form>
    </div>{{/Question_1}}

    <!-- Question 2 -->
    {{#Question_2}}<div class="question-block" data-question="2">
      <div class="question-header">
        <span class="question-number">2</span><span class="jp">{{kanji:Question_2}}</span>
      </div>
      <form class="shuffle" data-question="2">
        {{#option_2_1 (A)}}<div class="container" id="2_A" data-question="2" data-option="A">
          <input type="checkbox" name="radAnswer_2" class="checkbox" id="2_A">
          <div class="option"><span class="jp">{{kanji:option_2_1 (A)}}</span></div>
        </div>{{/option_2_1 (A)}}
        {{#option_2_2 (B)}}<div class="container" id="2_B" data-question="2" data-option="B">
          <input type="checkbox" name="radAnswer_2" class="checkbox" id="2_B">
          <div class="option"><span class="jp">{{kanji:option_2_2 (B)}}</span></div>
        </div>{{/option_2_2 (B)}}
        {{#option_2_3 (C)}}<div class="container" id="2_C" data-question="2" data-option="C">
          <input type="checkbox" name="radAnswer_2" class="checkbox" id="2_C">
          <div class="option"><span class="jp">{{kanji:option_2_3 (C)}}</span></div>
        </div>{{/option_2_3 (C)}}
        {{#option_2_4 (D)}}<div class="container" id="2_D" data-question="2" data-option="D">
          <input type="checkbox" name="radAnswer_2" class="checkbox" id="2_D">
          <div class="option"><span class="jp">{{kanji:option_2_4 (D)}}</span></div>
        </div>{{/option_2_4 (D)}}
        {{#option_2_5 (E)}}<div class="container" id="2_E" data-question="2" data-option="E">
          <input type="checkbox" name="radAnswer_2" class="checkbox" id="2_E">
          <div class="option"><span class="jp">{{kanji:option_2_5 (E)}}</span></div>
        </div>{{/option_2_5 (E)}}
        {{#option_2_6 (F)}}<div class="container" id="2_F" data-question="2" data-option="F">
          <input type="checkbox" name="radAnswer_2" class="checkbox" id="2_F">
          <div class="option"><span class="jp">{{kanji:option_2_6 (F)}}</span></div>
        </div>{{/option_2_6 (F)}}
        {{#option_2_7 (G)}}<div class="container" id="2_G" data-question="2" data-option="G">
          <input type="checkbox" name="radAnswer_2" class="checkbox" id="2_G">
          <div class="option"><span class="jp">{{kanji:option_2_7 (G)}}</span></div>
        </div>{{/option_2_7 (G)}}
        {{#option_2_8 (H)}}<div class="container" id="2_H" data-question="2" data-option="H">
          <input type="checkbox" name="radAnswer_2" class="checkbox" id="2_H">
          <div class="option"><span class="jp">{{kanji:option_2_8 (H)}}</span></div>
        </div>{{/option_2_8 (H)}}
      </form>
    </div>{{/Question_2}}

    <!-- Question 3 -->
    {{#Question_3}}<div class="question-block" data-question="3">
      <div class="question-header">
        <span class="question-number">3</span><span class="jp">{{kanji:Question_3}}</span>
      </div>
      <form class="shuffle" data-question="3">
        {{#option_3_1 (A)}}<div class="container" id="3_A" data-question="3" data-option="A">
          <input type="checkbox" name="radAnswer_3" class="checkbox" id="3_A">
          <div class="option"><span class="jp">{{kanji:option_3_1 (A)}}</span></div>
        </div>{{/option_3_1 (A)}}
        {{#option_3_2 (B)}}<div class="container" id="3_B" data-question="3" data-option="B">
          <input type="checkbox" name="radAnswer_3" class="checkbox" id="3_B">
          <div class="option"><span class="jp">{{kanji:option_3_2 (B)}}</span></div>
        </div>{{/option_3_2 (B)}}
        {{#option_3_3 (C)}}<div class="container" id="3_C" data-question="3" data-option="C">
          <input type="checkbox" name="radAnswer_3" class="checkbox" id="3_C">
          <div class="option"><span class="jp">{{kanji:option_3_3 (C)}}</span></div>
        </div>{{/option_3_3 (C)}}
        {{#option_3_4 (D)}}<div class="container" id="3_D" data-question="3" data-option="D">
          <input type="checkbox" name="radAnswer_3" class="checkbox" id="3_D">
          <div class="option"><span class="jp">{{kanji:option_3_4 (D)}}</span></div>
        </div>{{/option_3_4 (D)}}
        {{#option_3_5 (E)}}<div class="container" id="3_E" data-question="3" data-option="E">
          <input type="checkbox" name="radAnswer_3" class="checkbox" id="3_E">
          <div class="option"><span class="jp">{{kanji:option_3_5 (E)}}</span></div>
        </div>{{/option_3_5 (E)}}
        {{#option_3_6 (F)}}<div class="container" id="3_F" data-question="3" data-option="F">
          <input type="checkbox" name="radAnswer_3" class="checkbox" id="3_F">
          <div class="option"><span class="jp">{{kanji:option_3_6 (F)}}</span></div>
        </div>{{/option_3_6 (F)}}
        {{#option_3_7 (G)}}<div class="container" id="3_G" data-question="3" data-option="G">
          <input type="checkbox" name="radAnswer_3" class="checkbox" id="3_G">
          <div class="option"><span class="jp">{{kanji:option_3_7 (G)}}</span></div>
        </div>{{/option_3_7 (G)}}
        {{#option_3_8 (H)}}<div class="container" id="3_H" data-question="3" data-option="H">
          <input type="checkbox" name="radAnswer_3" class="checkbox" id="3_H">
          <div class="option"><span class="jp">{{kanji:option_3_8 (H)}}</span></div>
        </div>{{/option_3_8 (H)}}
      </form>
    </div>{{/Question_3}}

    <!-- Question 4 -->
    {{#Question_4}}<div class="question-block" data-question="4">
      <div class="question-header">
        <span class="question-number">4</span><span class="jp">{{kanji:Question_4}}</span>
      </div>
      <form class="shuffle" data-question="4">
        {{#option_4_1 (A)}}<div class="container" id="4_A" data-question="4" data-option="A">
          <input type="checkbox" name="radAnswer_4" class="checkbox" id="4_A">
          <div class="option"><span class="jp">{{kanji:option_4_1 (A)}}</span></div>
        </div>{{/option_4_1 (A)}}
        {{#option_4_2 (B)}}<div class="container" id="4_B" data-question="4" data-option="B">
          <input type="checkbox" name="radAnswer_4" class="checkbox" id="4_B">
          <div class="option"><span class="jp">{{kanji:option_4_2 (B)}}</span></div>
        </div>{{/option_4_2 (B)}}
        {{#option_4_3 (C)}}<div class="container" id="4_C" data-question="4" data-option="C">
          <input type="checkbox" name="radAnswer_4" class="checkbox" id="4_C">
          <div class="option"><span class="jp">{{kanji:option_4_3 (C)}}</span></div>
        </div>{{/option_4_3 (C)}}
        {{#option_4_4 (D)}}<div class="container" id="4_D" data-question="4" data-option="D">
          <input type="checkbox" name="radAnswer_4" class="checkbox" id="4_D">
          <div class="option"><span class="jp">{{kanji:option_4_4 (D)}}</span></div>
        </div>{{/option_4_4 (D)}}
        {{#option_4_5 (E)}}<div class="container" id="4_E" data-question="4" data-option="E">
          <input type="checkbox" name="radAnswer_4" class="checkbox" id="4_E">
          <div class="option"><span class="jp">{{kanji:option_4_5 (E)}}</span></div>
        </div>{{/option_4_5 (E)}}
        {{#option_4_6 (F)}}<div class="container" id="4_F" data-question="4" data-option="F">
          <input type="checkbox" name="radAnswer_4" class="checkbox" id="4_F">
          <div class="option"><span class="jp">{{kanji:option_4_6 (F)}}</span></div>
        </div>{{/option_4_6 (F)}}
        {{#option_4_7 (G)}}<div class="container" id="4_G" data-question="4" data-option="G">
          <input type="checkbox" name="radAnswer_4" class="checkbox" id="4_G">
          <div class="option"><span class="jp">{{kanji:option_4_7 (G)}}</span></div>
        </div>{{/option_4_7 (G)}}
        {{#option_4_8 (H)}}<div class="container" id="4_H" data-question="4" data-option="H">
          <input type="checkbox" name="radAnswer_4" class="checkbox" id="4_H">
          <div class="option"><span class="jp">{{kanji:option_4_8 (H)}}</span></div>
        </div>{{/option_4_8 (H)}}
      </form>
    </div>{{/Question_4}}

    <!-- Question 5 -->
    {{#Question_5}}<div class="question-block" data-question="5">
      <div class="question-header">
        <span class="question-number">5</span><span class="jp">{{kanji:Question_5}}</span>
      </div>
      <form class="shuffle" data-question="5">
        {{#option_5_1 (A)}}<div class="container" id="5_A" data-question="5" data-option="A">
          <input type="checkbox" name="radAnswer_5" class="checkbox" id="5_A">
          <div class="option"><span class="jp">{{kanji:option_5_1 (A)}}</span></div>
        </div>{{/option_5_1 (A)}}
        {{#option_5_2 (B)}}<div class="container" id="5_B" data-question="5" data-option="B">
          <input type="checkbox" name="radAnswer_5" class="checkbox" id="5_B">
          <div class="option"><span class="jp">{{kanji:option_5_2 (B)}}</span></div>
        </div>{{/option_5_2 (B)}}
        {{#option_5_3 (C)}}<div class="container" id="5_C" data-question="5" data-option="C">
          <input type="checkbox" name="radAnswer_5" class="checkbox" id="5_C">
          <div class="option"><span class="jp">{{kanji:option_5_3 (C)}}</span></div>
        </div>{{/option_5_3 (C)}}
        {{#option_5_4 (D)}}<div class="container" id="5_D" data-question="5" data-option="D">
          <input type="checkbox" name="radAnswer_5" class="checkbox" id="5_D">
          <div class="option"><span class="jp">{{kanji:option_5_4 (D)}}</span></div>
        </div>{{/option_5_4 (D)}}
        {{#option_5_5 (E)}}<div class="container" id="5_E" data-question="5" data-option="E">
          <input type="checkbox" name="radAnswer_5" class="checkbox" id="5_E">
          <div class="option"><span class="jp">{{kanji:option_5_5 (E)}}</span></div>
        </div>{{/option_5_5 (E)}}
        {{#option_5_6 (F)}}<div class="container" id="5_F" data-question="5" data-option="F">
          <input type="checkbox" name="radAnswer_5" class="checkbox" id="5_F">
          <div class="option"><span class="jp">{{kanji:option_5_6 (F)}}</span></div>
        </div>{{/option_5_6 (F)}}
        {{#option_5_7 (G)}}<div class="container" id="5_G" data-question="5" data-option="G">
          <input type="checkbox" name="radAnswer_5" class="checkbox" id="5_G">
          <div class="option"><span class="jp">{{kanji:option_5_7 (G)}}</span></div>
        </div>{{/option_5_7 (G)}}
        {{#option_5_8 (H)}}<div class="container" id="5_H" data-question="5" data-option="H">
          <input type="checkbox" name="radAnswer_5" class="checkbox" id="5_H">
          <div class="option"><span class="jp">{{kanji:option_5_8 (H)}}</span></div>
        </div>{{/option_5_8 (H)}}
      </form>
    </div>{{/Question_5}}

  </div>
  <div id="settings">
    <div id="gear">
      <svg width="50px" height="50px" viewBox="0 0 48 48" version="1" xmlns="http://www.w3.org/2000/svg"
        enable-background="new 0 0 48 48">
        <path fill="#607D8B"
          d="M39.6,27.2c0.1-0.7,0.2-1.4,0.2-2.2s-0.1-1.5-0.2-2.2l4.5-3.2c0.4-0.3,0.6-0.9,0.3-1.4L40,10.8 c-0.3-0.5-0.8-0.7-1.3-0.4l-5,2.3c-1.2-0.9-2.4-1.6-3.8-2.2l-0.5-5.5c-0.1-0.5-0.5-0.9-1-0.9h-8.6c-0.5,0-1,0.4-1,0.9l-0.5,5.5 c-1.4,0.6-2.7,1.3-3.8,2.2l-5-2.3c-0.5-0.2-1.1,0-1.3,0.4l-4.3,7.4c-0.3,0.5-0.1,1.1,0.3,1.4l4.5,3.2c-0.1,0.7-0.2,1.4-0.2,2.2 s0.1,1.5,0.2,2.2L4,30.4c-0.4,0.3-0.6,0.9-0.3,1.4L8,39.2c0.3,0.5,0.8,0.7,1.3,0.4l5-2.3c1.2,0.9,2.4,1.6,3.8,2.2l0.5,5.5 c0.1,0.5,0.5,0.9,1,0.9h8.6c0.5,0,1-0.4,1-0.9l0.5-5.5c1.4-0.6,2.7-1.3,3.8-2.2l5,2.3c0.5,0.2,1.1,0,1.3-0.4l4.3-7.4 c0.3-0.5,0.1-1.1-0.3-1.4L39.6,27.2z M24,35c-5.5,0-10-4.5-10-10c0-5.5,4.5-10,10-10c5.5,0,10,4.5,10,10C34,30.5,29.5,35,24,35z" />
        <path fill="#455A64"
          d="M24,13c-6.6,0-12,5.4-12,12c0,6.6,5.4,12,12,12s12-5.4,12-12C36,18.4,30.6,13,24,13z M24,30 c-2.8,0-5-2.2-5-5c0-2.8,2.2-5,5-5s5,2.2,5,5C29,27.8,26.8,30,24,30z" />
      </svg>
    </div>
    <div id="settings-content" style="display:none">
      <div id="zoom">
        <div id="positive">
          <svg width="50px" height="50px" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
            <title>70 Basic icons by Xicons.co</title>
            <path d="M24,3A21,21,0,1,0,45,24,21,21,0,0,0,24,3Z" fill="#afe0f5" />
            <path d="M32,26H16a2,2,0,0,1,0-4H32A2,2,0,0,1,32,26Z" fill="#38b1e7" />
            <path d="M24,34a2,2,0,0,1-2-2V16a2,2,0,0,1,4,0V32A2,2,0,0,1,24,34Z" fill="#38b1e7" />
          </svg>
        </div>
        <div id="default">
          <svg width="50px" height="50px" version="1.1" viewBox="0 0 496.17 496.17" xml:space="preserve"
            xmlns="http://www.w3.org/2000/svg">
            <path
              d="m5e-3 248.09c0-137.02 111.07-248.09 248.07-248.09 137.01 0 248.08 111.06 248.08 248.09 0 137-111.07 248.08-248.08 248.08-137.01 0-248.07-111.08-248.07-248.08z"
              fill="#32BEA6" />
            <path
              d="m400.81 169.58c-2.502-4.865-14.695-16.012-35.262-5.891-20.564 10.122-10.625 32.351-10.625 32.351 7.666 15.722 11.98 33.371 11.98 52.046 0 65.622-53.201 118.82-118.83 118.82-65.619 0-118.82-53.202-118.82-118.82 0-61.422 46.6-111.95 106.36-118.17v30.793s-0.084 1.836 1.828 2.999c1.906 1.163 3.818 0 3.818 0l98.576-58.083s2.211-1.162 2.211-3.436c0-1.873-2.211-3.205-2.211-3.205l-98.248-57.754s-2.24-1.605-4.23-0.826c-1.988 0.773-1.744 3.481-1.744 3.481v32.993c-88.998 6.392-159.23 80.563-159.23 171.21 0 94.824 76.873 171.7 171.69 171.7 94.828 0 171.71-76.872 171.71-171.7 1e-3 -28.298-6.852-54.98-18.972-78.505z"
              fill="#F7F7F7" />
          </svg>
        </div>
        <div id="negative">
          <svg width="50px" height="50px" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
            <title>70 Basic icons by Xicons.co</title>
            <path d="M24,3A21,21,0,1,0,45,24,21,21,0,0,0,24,3Z" fill="#f8bcc4" />
            <path d="M32,26H16a2,2,0,0,1,0-4H32A2,2,0,0,1,32,26Z" fill="#ee586c" />
          </svg>
        </div>
      </div>
      <div id="switch">
        <div class="check-box">
          <label for="Shuffling">Shuffling</label>
          <input id="Shuffling" type="checkbox">
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  //--------------------------persistence
  if (void 0 === window.Persistence) { var e = "github.com/SimonLammer/anki-persistence/", t = "_default"; if (window.Persistence_sessionStorage = function () { var i = !1; try { "object" == typeof window.sessionStorage && (i = !0, this.clear = function () { for (var t = 0; t < sessionStorage.length; t++) { var i = sessionStorage.key(t); 0 == i.indexOf(e) && (sessionStorage.removeItem(i), t--) } }, this.setItem = function (i, n) { void 0 == n && (n = i, i = t), sessionStorage.setItem(e + i, JSON.stringify(n)) }, this.getItem = function (i) { return void 0 == i && (i = t), JSON.parse(sessionStorage.getItem(e + i)) }, this.removeItem = function (i) { void 0 == i && (i = t), sessionStorage.removeItem(e + i) }, this.getAllKeys = function () { for (var t = [], i = Object.keys(sessionStorage), n = 0; n < i.length; n++) { var s = i[n]; 0 == s.indexOf(e) && t.push(s.substring(e.length, s.length)) } return t.sort() }) } catch (n) { } this.isAvailable = function () { return i } }, window.Persistence_windowKey = function (i) { var n = window[i], s = !1; "object" == typeof n && (s = !0, this.clear = function () { n[e] = {} }, this.setItem = function (i, s) { void 0 == s && (s = i, i = t), n[e][i] = s }, this.getItem = function (i) { return void 0 == i && (i = t), void 0 == n[e][i] ? null : n[e][i] }, this.removeItem = function (i) { void 0 == i && (i = t), delete n[e][i] }, this.getAllKeys = function () { return Object.keys(n[e]) }, void 0 == n[e] && this.clear()), this.isAvailable = function () { return s } }, window.Persistence = new Persistence_sessionStorage, Persistence.isAvailable() || (window.Persistence = new Persistence_windowKey("py")), !Persistence.isAvailable()) { var i = window.location.toString().indexOf("title"), n = window.location.toString().indexOf("main", i); i > 0 && n > 0 && n - i < 10 && (window.Persistence = new Persistence_windowKey("qt")) } }

  //---------------------------variables
  var answers = {
    1: "{{Ans_1}}",
    2: "{{Ans_2}}",
    3: "{{Ans_3}}",
    4: "{{Ans_4}}",
    5: "{{Ans_5}}"
  };

  // Process answers to uppercase
  Object.keys(answers).forEach(key => {
    if (answers[key] && answers[key] !== answers[key].toLowerCase()) {
      answers[key] = answers[key].toUpperCase();
    }
  });

  var allQuestions = [1, 2, 3, 4, 5];
  var activeQuestions = [];

  // Initialize question data
  allQuestions.forEach(qNum => {
    var questionElement = document.querySelector(`[data-question="${qNum}"]`);
    if (questionElement) {
      activeQuestions.push(qNum);
    }
  });

  Persistence.setItem("scroll", 0);
  Persistence.setItem("answers", {});

  //---------------------------------remove empty elements
  var divs = document.querySelectorAll('.option');
  divs.forEach(div => {
    if (div.innerHTML === '') {
      div.parentNode.remove();
    }
  });

  //------------------------------------zoom
  if (Persistence.getItem("Zoom") == null) {
    Persistence.setItem("Zoom", 1);
  }
  var zoom = Persistence.getItem("Zoom");
  $('.front').css('zoom', zoom);

  $('#positive').on('click', function () {
    zoom += 0.1;
    Persistence.setItem("Zoom", zoom);
    $('.front').css('zoom', zoom);
  });
  $('#default').on('click', function () {
    zoom = 1;
    Persistence.setItem("Zoom", zoom);
    $('.front').css('zoom', zoom);
  });
  $('#negative').on('click', function () {
    zoom -= 0.1;
    Persistence.setItem("Zoom", zoom);
    $('.front').css('zoom', zoom);
  });
  $('#gear').on('click', function () {
    $('#settings-content').toggle(50);
    setTimeout(function () {
      $('#myCard').scrollTop($('#myCard')[0].scrollHeight);
    }, 100);
  });

  //-------------------------------------functions
  document.getElementById("myCard").onscroll = function () {
    var scrollPosition = document.getElementById("myCard").scrollTop;
    Persistence.setItem("scroll", scrollPosition);
  };

  function ToggleCheck() {
    var mycheckBox = $(this).find("input[type='checkbox']");
    var cont = $(this);
    mycheckBox.prop("checked", !mycheckBox.prop("checked"));
    cont.toggleClass("check");
  }

  function storeAnswerBox() {
    var allAnswers = {};

    activeQuestions.forEach(qNum => {
      var answer = "";
      var checkboxes = document.querySelectorAll(`input[type="checkbox"][id^="${qNum}_"]`);

      checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
          var optionLetter = checkbox.id.split('_')[1];
          answer += optionLetter;
        }
      });

      allAnswers[qNum] = answer;
    });

    console.log("User answers:", allAnswers);
    Persistence.setItem("answers", allAnswers);
  }

  function shuffle(elems, questionNum) {
    var allElems = Array.from(elems);
    var shuffled = [];
    var originalIndices = allElems.map((_, index) => index); // Track original positions

    while (allElems.length > 0) {
      var random = Math.floor(Math.random() * allElems.length);
      var randEl = allElems[random].cloneNode(true);
      var originalIndex = originalIndices[random]; // Get the TRUE original position

      allElems.splice(random, 1);
      originalIndices.splice(random, 1); // Remove from tracking array too
      shuffled.push(randEl);

      // Store: original position -> new shuffled position
      var newPosition = shuffled.length - 1;
      Persistence.setItem("order_" + questionNum + "_" + originalIndex, newPosition);
    }

    console.log(`Shuffled question ${questionNum}`);

    elems.forEach((elem, index) => {
      if (shuffled[index]) {
        elem.parentNode.insertBefore(shuffled[index], elem.nextSibling);
        elem.parentNode.removeChild(elem);
      }
    });
  }

  function reverseShuffle(elems, questionNum) {
    var originalOrder = [];
    elems.forEach((elem, index) => {
      originalOrder.push({ elem: elem, originalIndex: index });
    });

    originalOrder.sort((a, b) => a.originalIndex - b.originalIndex);

    originalOrder.forEach((item, index) => {
      if (elems[index] && item.elem !== elems[index]) {
        elems[index].parentNode.insertBefore(item.elem, elems[index].nextSibling);
        elems[index].parentNode.removeChild(elems[index]);
      }
    });
  }

  function HandleShufflingBox() {
    Persistence.setItem("ShufflingBox", $("#Shuffling").is(":checked"));

    activeQuestions.forEach(qNum => {
      var questionElems = document.querySelectorAll(`[data-question="${qNum}"].container`);
      if ($("#Shuffling").is(":checked")) {
        shuffle(questionElems, qNum);
        addOptionLetters(); // Re-add letters in correct order after shuffle
      } else {
        reverseShuffle(questionElems, qNum);
        addOptionLetters(); // Re-add letters in correct order after reverse shuffle
      }
    });

    HandelEvents();
  }

  //------------------------------------------------
  if (Persistence.getItem("ShufflingBox") == null) {
    Persistence.setItem("ShufflingBox", false);
  }

  function addOptionLetters() {
    activeQuestions.forEach(qNum => {
      var containers = document.querySelectorAll(`[data-question="${qNum}"].container`);
      containers.forEach((container, index) => {
        var optionText = container.querySelector('.option');
        if (optionText) {
          // Remove existing letters first
          var existingLetters = optionText.querySelector('.Letters');
          if (existingLetters) {
            existingLetters.remove();
          }
          // Add letters in alphabetical order (A, B, C, D...)
          optionText.innerHTML = "<span class='Letters'>(" + String.fromCharCode(65 + index) + ")&nbsp;</span>" + optionText.innerHTML;
        }
      });
    });
  }

  // Add option letters to each question initially
  addOptionLetters();

  document.querySelector("#Shuffling").addEventListener("click", HandleShufflingBox);
  $("#Shuffling").prop("checked", Persistence.getItem("ShufflingBox"));

  if ($("#Shuffling").is(":checked")) {
    activeQuestions.forEach(qNum => {
      var questionElems = document.querySelectorAll(`[data-question="${qNum}"].container`);
      shuffle(questionElems, qNum);
      addOptionLetters(); // Re-add letters in correct order after shuffle
    });
  }

  function HandelEvents() {
    activeQuestions.forEach(qNum => {
      var containers = document.querySelectorAll(`[data-question="${qNum}"].container`);
      containers.forEach(container => {
        container.addEventListener("click", ToggleCheck);
        container.addEventListener("click", storeAnswerBox);
      });
    });
  }

  HandelEvents();

  // Text highlighting functionality
  function deselect() {
    $(this).replaceWith(this.innerHTML);
    $(".highlighted").click(deselect);
  }

  $(document).on("mouseup", function (e) {
    var selected = window.getSelection();
    if (selected.rangeCount > 0) {
      var range = selected.getRangeAt(0);
      if (selected.toString().length > 0) {
        var newNode = document.createElement("span");
        newNode.setAttribute("class", "highlighted");
        newNode.addEventListener("click", deselect);
        try {
          range.surroundContents(newNode);
        } catch (e) {
          console.log("Could not highlight selection");
        }
      }
    }
  });
  // Japanese text space removal
  function removeSpaces() {
    document.querySelectorAll('.jp').forEach(el => {
      el.innerHTML = el.innerHTML
        // Remove newlines and surrounding whitespace
        .replace(/\s*\n\s*/g, '')

        // Remove continuous halfwidth spaces before kanji
        .replace(/\u0020+([\u4E00-\u9FAF\u3400-\u4DBF])/g, '$1')

        // Remove halfwidth spaces after punctuation
        .replace(/([～。、！？：；])\u0020+/g, '$1')
    })
  }
  removeSpaces();
</script>